before:
  hooks:
    - mkdir -p caddy-build
    - cp cmd/caddy/main.go caddy-build/main.go
    - cp ./go.mod caddy-build/go.mod
    - sed -i.bkp s/github.com\/caddyserver\/caddy\/v2/caddy/g ./caddy-build/go.mod
    # GoReleaser doesn't seem to offer {{.Tag}} at this stage, so we have to embed it into the env
    # so we run: TAG=$(git describe --abbrev=0) goreleaser release --rm-dist --skip-publish --skip-validate
    - go mod edit -require=github.com/caddyserver/caddy/v2@{{.Env.TAG}} ./caddy-build/go.mod
    - git clone --depth 1 https://github.com/caddyserver/dist caddy-dist
    - go mod download
builds:
- env:
  - CGO_ENABLED=0
  - GO111MODULE=on
  main: main.go
  dir: ./caddy-build
  binary: caddy
  goos:
  - darwin
  - linux
  - windows
  - freebsd
  flags:
  - -trimpath
  ldflags:
  - -s -w
archives:
- replacements:
    darwin: Darwin
    linux: Linux
    windows: Windows
    386: i386
    amd64: x86_64
checksum:
  algorithm: sha256
# signs:
# - artifacts: all
#   cmd: signify
#   args: ["-S", "-s", "../seckey", "-m", "${artifact}"]
nfpms:
- package_name: caddy
  homepage: https://caddyserver.com
  description: Caddy Web Server
  license: Apache 2.0
  bindir: /usr/bin
  formats:
  - deb
  - rpm
  empty_folders:
  - /etc/caddy
  files:
    "caddy-dist/init/caddy.service": "/etc/systemd/system/caddy.service"
    "caddy-dist/config/Caddyfile": "/etc/caddy/Caddyfile"
changelog:
  sort: asc
  filters:
    exclude:
    - '^docs:'
    - '^test:'
    - '^\w+\s+' # a hack to remove commit messages without colons thus don't correspond to a package
